@app.route("/api/aulas/saida", methods=["POST"])
@require_auth
def saida():
    d = request.json or {}
    aula_id = d.get("aula_id")
    aluno_id = d.get("aluno_id")
    retirado_por = d.get("retirado_por", "")

    if not aula_id or not aluno_id:
        return api_error("aula_id e aluno_id são obrigatórios")

    conn = db()
    cur = conn.cursor()

    # tenta atualizar a frequência existente
    cur.execute("""
        UPDATE frequencia
        SET horario_saida=%s, retirado_por=%s
        WHERE id_aula=%s AND id_aluno=%s
    """, (datetime.now(), retirado_por, aula_id, aluno_id))

    # se não existia check-in ainda, cria registro com saída (caso raro)
    if cur.rowcount == 0:
        cur.execute("""
            INSERT INTO frequencia (id_aula,id_aluno,horario_entrada,horario_saida,retirado_por)
            VALUES (%s,%s,%s,%s,%s)
            ON CONFLICT (id_aula,id_aluno)
            DO UPDATE SET horario_saida=%s, retirado_por=%s
        """, (aula_id, aluno_id, datetime.now(), datetime.now(), retirado_por,
              datetime.now(), retirado_por))

    conn.commit()
    cur.close()
    conn.close()
    return jsonify({"ok": True})
